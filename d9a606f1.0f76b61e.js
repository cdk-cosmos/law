(window.webpackJsonp=window.webpackJsonp||[]).push([[204],{260:function(e,t,o){"use strict";o.r(t),o.d(t,"frontMatter",(function(){return a})),o.d(t,"metadata",(function(){return s})),o.d(t,"rightToc",(function(){return c})),o.d(t,"default",(function(){return p}));var n=o(2),r=o(6),i=(o(0),o(292)),a={id:"getting_started_core",title:"Getting Started with the Core",sidebar_label:"Core"},s={unversionedId:"getting_started_core",id:"getting_started_core",isDocsHomePage:!1,title:"Getting Started with the Core",description:"In the previous step, we bootstrapped the bootstrap code. This gave us IAM roles and a codebuild project, which we can now use to bootstrap Cosmos into the account defined in your lib/main.ts file.",source:"@site/guides/getting_started_core.md",permalink:"/law/guides/getting_started_core",editUrl:"https://github.com/cdk-cosmos/law/edit/master/guides/getting_started_core.md",sidebar_label:"Core",sidebar:"guides",previous:{title:"Getting Started - Bootstrapping",permalink:"/law/guides/getting_started_bootstrap"},next:{title:"Getting Started with Extensions",permalink:"/law/guides/getting_started_extension"}},c=[{value:"What you&#39;ll get",id:"what-youll-get",children:[]},{value:"Solar systems",id:"solar-systems",children:[]},{value:"Next Steps",id:"next-steps",children:[]},{value:"Next Step: Deploying Cosmos Extension",id:"next-step-deploying-cosmos-extension",children:[]}],l={rightToc:c};function p(e){var t=e.components,a=Object(r.a)(e,["components"]);return Object(i.b)("wrapper",Object(n.a)({},l,a,{components:t,mdxType:"MDXLayout"}),Object(i.b)("p",null,"In the previous step, we bootstrapped the bootstrap code. This gave us IAM roles and a codebuild project, which we can now use to bootstrap Cosmos into the account defined in your lib/main.ts file."),Object(i.b)("p",null,"In the previous step, we bootstrapped the bootstrap toolkit. This gave us IAM roles and a codebuild project, which we can now use to bootstrap Cosmos into the management account defined in your ",Object(i.b)("inlineCode",{parentName:"p"},"lib/main.ts")," file."),Object(i.b)("p",null,"To bootstrap your Cosmos core, run the below command in the base directory of your project, with credentials for the master account exported."),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{}),'npx cdk --app "node_modules/@cosmos-building-blocks/common/lib/cdk-toolkit/bootstrap-app.js" deploy\n')),Object(i.b)("p",null,"This will archive your current working directory and pass it as an asset to the CDK Toolkit s3 bucket in your master account, and trigger the CodeBuild job to bootstrap your Cosmos core."),Object(i.b)("blockquote",null,Object(i.b)("p",{parentName:"blockquote"},"There is a known issue with this step in some versions of CDK Cosmos, due to naming changes in later versions of AWS CDK. See ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/cdk-cosmos/cosmos/issues/304"}),"issue #304"),' for updates. If this step doesn\'t deploy the resources needed (e.g. no new stacks are created), use STACKS="--all" npx cdk --app "node_modules/@cosmos-building-blocks/common/lib/cdk-toolkit/bootstrap-app.js" deploy ')),Object(i.b)("p",null,"A CodeCommit repository to house this newly customised Core was created as part of the bootstrapping process above. You should now update your local repository to point to the new CodeCommit repository. Replacing the ",Object(i.b)("em",{parentName:"p"},"your-region")," section with the region you selected in ",Object(i.b)("inlineCode",{parentName:"p"},"bin/main.ts"),", run the following command:"),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{}),'git remote set-url origin "https://git-codecommit.your-region.amazonaws.com/v1/repos/core-cdk-repo"\n')),Object(i.b)("p",null,"Add the changes made to this template by running ",Object(i.b)("inlineCode",{parentName:"p"},"git add ."),", commit the changes by running ",Object(i.b)("inlineCode",{parentName:"p"},'git commit -m "inital commit"'),", and push the changes to CodeCommit by running ",Object(i.b)("inlineCode",{parentName:"p"},"git push")," with your AWS master account credentials exported in the CLI."),Object(i.b)("h3",{id:"what-youll-get"},"What you'll get"),Object(i.b)("p",null,Object(i.b)("em",{parentName:"p"},"Sample Pattern with Management, Development & Production Accounts, with two Solar Systems in Dev (Dev & Test):")),Object(i.b)("p",null,Object(i.b)("img",{src:o(324).default})),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Cosmos Resources")),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"TLD (top level domain), e.g. demo.site.com"),Object(i.b)("li",{parentName:"ul"},"Master role that creates resources and can assume cross-account roles to create resources in those accounts"),Object(i.b)("li",{parentName:"ul"},"Pipeline to deploy new resources if needed (",Object(i.b)("em",{parentName:"li"},"Core-DemoApp-Cdk-Pipeline"),")")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Galaxy Resources")),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"Cross-account role that master can assume "),Object(i.b)("li",{parentName:"ul"},"Shared KMS encrytion key, can be used by solar systems to encrypt things")),Object(i.b)("h3",{id:"solar-systems"},"Solar systems"),Object(i.b)("p",null,"On the first run of the pipeline, solar systems are commented out in ",Object(i.b)("inlineCode",{parentName:"p"},"bin/main.ts"),". This is to avoid dependency issues, as the solar systems rely on resources that are created on the first run through of the pipeline. When you uncomment the solar system and run the pipeline, it will create a new deploy stage in the pipeline to deploy to the new environment if you have something like the below code (provided by default)."),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{}),'// Add NON-PRD deploy stage\nciCd.ciCd?.addDeployStackStage({\n    name: "DeployNonPrd",\n    stacks: [dev],\n});\n')),Object(i.b)("p",null,"CDK Cosmos is currently using AWS Code Pipelines, which will pause and need to be re-run when a change is made to the pipeline itself. A way to minimise pipeline runs is to add a CiCd stage to your pipeline, which will deploy the changes to CiCd early on instead of waiting until the final deploy stage."),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{}),'// Add CiCd deploy stage\nciCd.ciCd?.addDeployStackStage({\n    name: "DeployCiCd",\n    stacks: [ciCd],\n    isManualApprovalRequired: false,\n});\n')),Object(i.b)("p",null,"You can also achieve the same effect with a more manual step, by starting the build projects with an override to deploy only the CiCd stack. You will need to set stack to ",Object(i.b)("inlineCode",{parentName:"p"},"-e *CiCd*")," (for earlier versions of Cosmos) or the full name of the CiCd stack if using a later (AWS CDK 1.104+ won't accept wildcard naming)."),Object(i.b)("p",null,"Future versions of CDK Cosmos may switch to using the new CDK Pipeline construct, which is self-mutating, and will remove some of the duplicate runs of the pipeline."),Object(i.b)("blockquote",null,Object(i.b)("p",{parentName:"blockquote"},"If using a version of CDK Cosmos that is below 0.8.12, using certs in your solar system may require going into AWS Certificate manager to create a route 53 record. That is outside the scope of this guide - it is recommended to use the latest version of CDK Cosmos to access the latest features and bug fixes.")),Object(i.b)("h4",{id:"what-you-have-now"},"What you have now"),Object(i.b)("p",null,"Solar system in each environment defined in ",Object(i.b)("inlineCode",{parentName:"p"},"bin/main.ts")),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"vpc and subdomain (e.g. dev, tst, prd from tld)"),Object(i.b)("li",{parentName:"ul"},"certificates (optional)")),Object(i.b)("h3",{id:"next-steps"},"Next Steps"),Object(i.b)("p",null,"Once you've bootstrapped your Cosmos core, you can use these resources within extensions to build out your apps."),Object(i.b)("hr",null),Object(i.b)("h2",{id:"next-step-deploying-cosmos-extension"},Object(i.b)("a",Object(n.a)({parentName:"h2"},{href:"/law/guides/getting_started_extension"}),"Next Step: Deploying Cosmos Extension")))}p.isMDXComponent=!0},292:function(e,t,o){"use strict";o.d(t,"a",(function(){return u})),o.d(t,"b",(function(){return m}));var n=o(0),r=o.n(n);function i(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function a(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,n)}return o}function s(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?a(Object(o),!0).forEach((function(t){i(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):a(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function c(e,t){if(null==e)return{};var o,n,r=function(e,t){if(null==e)return{};var o,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)o=i[n],t.indexOf(o)>=0||(r[o]=e[o]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)o=i[n],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(r[o]=e[o])}return r}var l=r.a.createContext({}),p=function(e){var t=r.a.useContext(l),o=t;return e&&(o="function"==typeof e?e(t):s(s({},t),e)),o},u=function(e){var t=p(e.components);return r.a.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},b=r.a.forwardRef((function(e,t){var o=e.components,n=e.mdxType,i=e.originalType,a=e.parentName,l=c(e,["components","mdxType","originalType","parentName"]),u=p(o),b=n,m=u["".concat(a,".").concat(b)]||u[b]||d[b]||i;return o?r.a.createElement(m,s(s({ref:t},l),{},{components:o})):r.a.createElement(m,s({ref:t},l))}));function m(e,t){var o=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var i=o.length,a=new Array(i);a[0]=b;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:n,a[1]=s;for(var l=2;l<i;l++)a[l]=o[l];return r.a.createElement.apply(null,a)}return r.a.createElement.apply(null,o)}b.displayName="MDXCreateElement"},324:function(e,t,o){"use strict";o.r(t),t.default=o.p+"assets/images/cosmos-core-bootstrap-566fb257eef7f87fafbfd5e8ce96cef4.png"}}]);