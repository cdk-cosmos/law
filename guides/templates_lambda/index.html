<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.61">
<title data-react-helmet="true">Building a Lambda Template | Cdk Cosmos Law</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="Building a Lambda Template | Cdk Cosmos Law"><meta data-react-helmet="true" name="description" content="This guide is designed to walk you through adding resources to the blank template to support an AWS Lambda patterned extension, in order to clarify how CDK-Cosmos works. We will be creating a lambda behind an ALB within a VPC to create a private site."><meta data-react-helmet="true" property="og:description" content="This guide is designed to walk you through adding resources to the blank template to support an AWS Lambda patterned extension, in order to clarify how CDK-Cosmos works. We will be creating a lambda behind an ALB within a VPC to create a private site."><meta data-react-helmet="true" property="og:url" content="https://cdk-cosmos.github.io//law/guides/templates_lambda"><link data-react-helmet="true" rel="shortcut icon" href="/law/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://cdk-cosmos.github.io//law/guides/templates_lambda"><link rel="stylesheet" href="/law/styles.6eaf09fd.css">
<link rel="preload" href="/law/styles.e4c59df8.js" as="script">
<link rel="preload" href="/law/runtime~main.86f6e787.js" as="script">
<link rel="preload" href="/law/main.3bdcd07c.js" as="script">
<link rel="preload" href="/law/1.8571fb6d.js" as="script">
<link rel="preload" href="/law/2.2961cee2.js" as="script">
<link rel="preload" href="/law/236.315ef293.js" as="script">
<link rel="preload" href="/law/237.a932438a.js" as="script">
<link rel="preload" href="/law/284db4bf.4c9bf30e.js" as="script">
<link rel="preload" href="/law/17896441.15f9fc3d.js" as="script">
<link rel="preload" href="/law/994b2ab4.91efbcac.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/law/"><img class="navbar__logo" src="/law/img/cdk-cosmos-crop.png" alt="Cdk Cosmos"><strong class="navbar__title">Cdk Cosmos</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/law/guides/">Guides</a><a class="navbar__item navbar__link" href="/law/docs/">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/cdk-cosmos" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/law/"><img class="navbar__logo" src="/law/img/cdk-cosmos-crop.png" alt="Cdk Cosmos"><strong class="navbar__title">Cdk Cosmos</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/law/guides/">Guides</a></li><li class="menu__list-item"><a class="menu__link" href="/law/docs/">Docs</a></li><li class="menu__list-item"><a href="https://github.com/cdk-cosmos" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/law/guides/">Introduction</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Getting Started</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/law/guides/getting_started_bootstrap">Bootstrapper</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/law/guides/getting_started_core">Core</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/law/guides/getting_started_extension">Extensions</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/law/guides/getting_started_app">Hello World App</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Template Building</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/law/guides/templates_intro">Building Your Own Templates</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/law/guides/templates_ecr">ECR Template</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/law/guides/templates_lambda">Lambda Template</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_1EkI"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">Building a Lambda Template</h1></header><div class="markdown"><p>This guide is designed to walk you through adding resources to the <a href="https://github.com/cdk-cosmos/cosmos-blank-extension-cdk" target="_blank" rel="noopener noreferrer">blank template</a> to support an AWS Lambda patterned extension, in order to clarify how CDK-Cosmos works. We will be creating a lambda behind an ALB within a VPC to create a private site.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="libci-cd-solar-systemts"></a>lib/ci-cd-solar-system.ts<a aria-hidden="true" tabindex="-1" class="hash-link" href="#libci-cd-solar-systemts" title="Direct link to heading">#</a></h3><p>You will need to import AWS s3 bucket and StandardPipeline from the CDK-Cosmos building blocks.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">import { Bucket } from &#x27;@aws-cdk/aws-s3&#x27;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import { BuildSpecBuilder, StandardPipeline } from &#x27;@cosmos-building-blocks/pipeline&#x27;;</span></div></div></div></div></div><p>To the exports, you will need to add a lambda bucket and a standard pipeline. Currently recommending standard pipeline for lambda, which requires the use of a Makefile in your app code, but in future there may be a custom lambda pipeline. </p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">readonly lambdaBucket: Bucket;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">readonly codePipeline: StandardPipeline;</span></div></div></div></div></div><p>Inside the constructor, add the below code after <code>super();</code>. StandardPipeline provides a default build spec (<code>buildSpec: StandardPipeline.DefaultBuildSpec()</code> to use), but we&#x27;re passing a custom one to build the lambda function.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">//get app code repo (CodeCommit) and code bucket (s3) from cosmos</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">const { codeRepo, codeBucket } = this.galaxy.cosmos;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">const buildSpec = new BuildSpecBuilder()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  .addRuntime(&#x27;nodejs&#x27;, &#x27;12&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  .addCommands(&#x27;pre_build&#x27;, &#x27;make install&#x27;, &#x27;export APP_BUILD_VERSION=$(make version)&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  .addCommands(&#x27;build&#x27;, &#x27;make build&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  .addCommands(&#x27;post_build&#x27;, `export CODE_BUCKET=${codeBucket.bucketName}`, &#x27;make zip&#x27;, &#x27;make push&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  .addExportedVariables(&#x27;APP_BUILD_VERSION&#x27;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">//StandardPipeline requires a Makefile in your app code</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">this.codePipeline = new StandardPipeline(this, &#x27;CodePipeline&#x27;, {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  pipelineName: this.galaxy.cosmos.nodeId(&#x27;Code-Pipeline&#x27;, &#x27;-&#x27;),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  buildName: this.galaxy.cosmos.nodeId(&#x27;Code-Build&#x27;, &#x27;-&#x27;),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  codeRepo: codeRepo,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  buildSpec,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">});</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">//Grant necessary code bucket permissions</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">codeBucket.grantWrite(this.codePipeline.buildRole);</span></div></div></div></div></div><p>This section is optional but recommended. The template includes a function to allow you to add discrete stages to your cdk pipeline to deploy individual stacks by referencing the function in <code>bin/main.ts</code>. The below function allows you to add stages to your standard pipeline. If desired, add this code below <code>addCdkDeployEnvStageToCdkPipeline()</code>, within the <code>export</code> statement.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">addCdkDeployEnvStageToCodePipeline(props: { name: string; stacks: Stack[]; isManualApprovalRequired?: boolean }) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    this.ciCd.addDeployStackStage({</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ...props,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pipeline: this.codePipeline.pipeline,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    envs: StandardPipeline.DefaultAppBuildVersionStageEnv(),//passes app build version</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="libcosmosts"></a>lib/cosmos.ts<a aria-hidden="true" tabindex="-1" class="hash-link" href="#libcosmosts" title="Direct link to heading">#</a></h3><p>This file sets up the Code Repository (AWS CodeCommit) and Code Bucket (s3) for your extension.</p><p>Add the following imports:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">import { Repository as CodeRepository } from &quot;@aws-cdk/aws-codecommit&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import { Bucket } from &#x27;@aws-cdk/aws-s3&#x27;;</span></div></div></div></div></div><p>Replace the export function with the below code. </p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">export class AppCosmosStack extends CosmosExtensionStack {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  readonly codeBucket: Bucket;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  readonly codeRepo: CodeRepository;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  constructor(scope: Construct, id: string, props?: StackProps) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    super(scope, id, props);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    this.codeRepo = new CodeRepository(this, &#x27;CodeRepo&#x27;, {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      repositoryName: this.nodeId(&#x27;Code-Repo&#x27;, &#x27;-&#x27;).toLowerCase(),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    this.codeBucket = new Bucket(this, &#x27;CodeBucket&#x27;, {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      bucketName: this.nodeId(&#x27;Code-Bucket&#x27;, &#x27;-&#x27;).toLowerCase(),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="bingalaxyts"></a>bin/galaxy.ts<a aria-hidden="true" tabindex="-1" class="hash-link" href="#bingalaxyts" title="Direct link to heading">#</a></h3><p>This file will remain unchanged, as we don&#x27;t need to create any resources at the galaxy (account) level. Resources are either scoped to the cosmos (management account) or solar system (dev, test, prod environment etc) level.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="libsolar-systemts"></a>lib/solar-system.ts<a aria-hidden="true" tabindex="-1" class="hash-link" href="#libsolar-systemts" title="Direct link to heading">#</a></h3><p>You will need to import the following constructs:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">import { SolarSystemExtensionStack, SolarSystemExtensionStackProps } from &#x27;@cdk-cosmos/core&#x27;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import { SsmState } from &#x27;@cosmos-building-blocks/common&#x27;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import { Function, Runtime, Code } from &#x27;@aws-cdk/aws-lambda&#x27;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import { AppGalaxyStack } from &#x27;.&#x27;;</span></div></div></div></div></div><p>Add tag to solar system props</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">export interface AppSolarSystemProps extends SolarSystemExtensionStackProps {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  appVersion?: string;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div></div></div><p>Add readonly bucket inside export statement</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">readonly bucket: Bucket;</span></div></div></div></div></div><p>Add the following inside the constructor, after <code>super();</code>. Here, you are using the codeBucket from <code>lib/cosmos.ts</code> and the shared vpc through the portal construct. version state is managed through a CDK Cosmos feature.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">const { appVersion } = props || {};</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">const { codeBucket } = this.galaxy.cosmos;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">const { vpc } = this.portal;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">const versionState = new SsmState(this, &#x27;VersionState&#x27;, {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name: &#x27;/&#x27; + this.nodeId(&#x27;VersionState&#x27;, &#x27;/&#x27;),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  value: appVersion,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">});</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">//handler must be the same as the export from your app</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">const serverFunction = new Function(this, &#x27;ServerFunction&#x27;, {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  handler: &#x27;app.lambdaHandler&#x27;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  code: Code.fromBucket(codeBucket, `function-${appVersion}.zip`),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  runtime: Runtime.NODEJS_12_X,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  environment: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    REGION: &#x27;ap-southeast-2&#x27;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  vpc,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">});</span></div></div></div></div></div><blockquote><p>Note: This template uses the SsmState construct, which has an active issue in the Cosmos backlog - (Issue #318)[https://github.com/cdk-cosmos/cosmos/issues/318]. Currently, you will need to pass a hardcoded appVersion on the first run of the pipeline so that a parameter is added to the AWS Parameter Store in each solar system. See details below on setting up the sample lambda app.</p></blockquote><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">const versionState = new SsmState(this, &#x27;VersionState&#x27;, {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name: &#x27;/&#x27; + this.nodeId(&#x27;VersionState&#x27;, &#x27;/&#x27;),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  value: 1,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">});</span></div></div></div></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="to-add-front-end-you-will-need-a-few-extra-resources"></a>To add front end you will need a few extra resources:<a aria-hidden="true" tabindex="-1" class="hash-link" href="#to-add-front-end-you-will-need-a-few-extra-resources" title="Direct link to heading">#</a></h4><p>imports</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">import { RecordTarget, ARecord } from &#x27;@aws-cdk/aws-route53&#x27;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import { LoadBalancerTarget } from &#x27;@aws-cdk/aws-route53-targets&#x27;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import { ApplicationTargetGroup, ListenerCondition } from &#x27;@aws-cdk/aws-elasticloadbalancingv2&#x27;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import { LambdaTarget } from &#x27;@aws-cdk/aws-elasticloadbalancingv2-targets&#x27;;</span></div></div></div></div></div><p>in constructor</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">const { alb, httpsListener } = this.portal.addEcs();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">const recordName = `slackbot.${this.portal.zone.zoneName}`;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">const serverTargetGroup = new ApplicationTargetGroup(this, &#x27;ServerTargetGroup&#x27;, {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  targets: [new LambdaTarget(serverFunction)],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">});</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">httpsListener.addTargetGroups(&#x27;ServerTargets&#x27;, {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  conditions: [ListenerCondition.hostHeaders([recordName])],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  priority: 9500,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  targetGroups: [serverTargetGroup],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">});</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">new ARecord(this, &#x27;Alias&#x27;, {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  zone: this.portal.zone,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  recordName,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  target: RecordTarget.fromAlias(new LoadBalancerTarget(alb)),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">});</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="binmaints"></a>bin/main.ts<a aria-hidden="true" tabindex="-1" class="hash-link" href="#binmaints" title="Direct link to heading">#</a></h3><p>As mentioned in the intro, this file instantiates all the resources you have defined in the above files and is where you can design your Cosmos infrastructure, including AWS accounts, stacks and pipeline stages.</p><p>Add the following to imports. This is required to update IAM policies to allow cross account access to Cosmos resources</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">import { PolicyStatement, Effect, AccountPrincipal } from &#x27;@aws-cdk/aws-iam&#x27;;</span></div></div></div></div></div><p>You will need to change the app name from &#x27;Demo&#x27; in the below line:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">const cosmos = new AppCosmosStack(app, &#x27;Demo&#x27;, {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  env: mgtEnvConfig,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">});  </span></div></div></div></div></div><p>To the cosmos stack (after <code>const cosmos</code>), add a resource policy to the code bucket. You will need to add all environments as account principals so they can access the zip file of the lambda code, which is stored in the management account.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">cosmos.codeBucket.addToResourcePolicy(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  new PolicyStatement({</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    actions: [&#x27;s3:*&#x27;],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    principals: [new AccountPrincipal(devEnvConfig.account), new AccountPrincipal(prdEnvConfig.account)],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    resources: [cosmos.codeBucket.bucketArn, `${cosmos.codeBucket.bucketArn}/*`],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    effect: Effect.ALLOW,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  })</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div></div></div></div></div><p>In this file, you set the environment configuration for each galaxy and then instantiate a galaxy per account. Examples are included in the blank template. Duplicate these and replace the names as needed. It is essential that names match those set in your core CDK-Cosmos, e.g. <code>Dev</code> must be consistently named.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">const devEnvConfig = { account: &#x27;2222&#x27;, region: &#x27;ap-southeast-2&#x27; };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">const devGalaxy = new AppGalaxyStack(cosmos, &#x27;Dev&#x27;, {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  env: devEnvConfig,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">});</span></div></div></div></div></div><p>For each solar system, create a new solar system stack, ensuring the name matches with your core Cosmos. This allows the portal construct to use resources from core cosmos. You will also need to pass app version as a prop.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// // Extend the Dev SolarSystem, by creating service</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// const dev = new AppSolarSystemStack(devGalaxy, &#x27;Dev&#x27;, {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">//   tag: process.env.APP_BUILD_VERSION || &#x27;v0.0.0&#x27;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// });</span></div></div></div></div></div><blockquote><p><strong>Important note with solar systems:</strong> Currently, solar systems must be commented out in the first run of the bootstrapper. You can then uncomment solar systems, push up your changes and re-run the cdk pipeline. See <a href="/law/guides/getting_started_extension#solar-systems">Getting Started - Extension # Solar Systems</a> for more information. </p></blockquote><p>Optionally, add a deployment stage in the pipeline to target specific solar systems (can pass one or multiple stacks). If not, all stacks will be deployed in the final deploy stage of the pipeline. It is, however, recommended to separate dev and prod as a minimum. </p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// // Add a Deployment stage in App Pipeline to target this</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// ciCd.addCdkDeployEnvStageToCodePipeline({</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">//   name: &#x27;DeployDev&#x27;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">//   stacks: [dev],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">//   isManualApprovalRequired: false,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// });</span></div></div></div></div></div><p>Again optionally, you can also add a separate stage in the CDK pipeline to target specific stacks</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// ciCd.addCdkDeployEnvStageToCdkPipeline({</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">//   name: &#x27;DeployDev&#x27;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">//   stacks: [dev],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">//   isManualApprovalRequired: false,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// });</span></div></div></div></div></div><p>As with the solar system, this should be commented out in the first run (as the solar system targeted by this pipeline stage has not yet been created). When you re-run the cdk pipeline, it will change itself to add the new stage. Changes to the pipeline will make it pause, and you will have to re-run it again. This is a property of CodePipeline, and something that may be addressed in future versions of CDK-Cosmos by implementing the new CDK Pipeline construct provided by AWS. In the meantime, the blank template includes an optional CiCd stage in the pipeline, which will allow you to deploy any changes needed to the CiCd infrastructure first and minimise waiting time on additional runs of the pipeline.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">//Optional: Add CiCd deploy stage to code pipeline to deploy CiCd before other stacks</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ciCd.addCdkDeployEnvStageToCodePipeline({</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    name: &#x27;DeployCiCd&#x27;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    stacks: [ciCd],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    isManualApprovalRequired: false,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">});</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">//Optional: Add CiCd deploy stage to CDK pipeline to deploy CiCd before other stacks</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ciCd.ciCd?.addDeployStackStage({</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    name: &quot;DeployCiCd&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    stacks: [ciCd],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    isManualApprovalRequired: false,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">});</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="internet-connectivity"></a>Internet connectivity<a aria-hidden="true" tabindex="-1" class="hash-link" href="#internet-connectivity" title="Direct link to heading">#</a></h2><p>Lambdas within a VPC cannot by default access the internet. If you require that functionality, please refer to this (AWS guide)[https://aws.amazon.com/premiumsupport/knowledge-center/internet-access-lambda-function/]</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="final-steps"></a>Final Steps<a aria-hidden="true" tabindex="-1" class="hash-link" href="#final-steps" title="Direct link to heading">#</a></h2><p>At the end of this guide, you should have all the resources needed to upload a lambda function to your bootstrapped extension. You will be able to test it out by uploading the <a href="https://github.com/cdk-cosmos/cosmos-sample-lambda-app" target="_blank" rel="noopener noreferrer">sample lambda app</a> or your own app to the CodeCommit app-*-code-repo that will be created when you bootstrap your extension and running the code pipeline.</p><blockquote><p>Note: This template uses the SsmState construct, which has an active issue in the Cosmos backlog - (Issue #318)[https://github.com/cdk-cosmos/cosmos/issues/318]. Currently, you will need to pass a hardcoded appVersion on the first run of the pipeline so that a parameter is added to the AWS Parameter Store in each solar system. You may also need to manually zip up and push your lambda function the first time, to create the app version parameter. If you are using the sample lambda app, you will be able to use the commands in the Makefile to achieve this:</p></blockquote><ul><li><p>(Bootstrap)[getting_started_extension.md] the template you have just created</p></li><li><p>Set versionState to <code>&quot;1&quot;</code> in <code>lib/solar-system.ts</code></p><p>  const versionState = new SsmState(this, &#x27;VersionState&#x27;, {
name: &#x27;/&#x27; + this.nodeId(&#x27;VersionState&#x27;, &#x27;/&#x27;),
value: 1,
});</p></li><li><p>Clone the sample lambda app and <code>git set-url remote origin https://your-code-repo</code> where your-code-repo is the url of the code repository created in the bootstrapping process</p></li><li><p>Export the name of the s3 bucket created in the management account as CODE_BUCKET and the app build </p><p>  export CODE_BUCKET=app-demo-code-bucket
export APP_BUILD_VERSION=1</p></li><li><p>Use the commands in the Makefile to build, zip &amp; push the sample app up to your repo</p><p>  make install
make build
make zip
make push</p></li></ul><p>Once you&#x27;ve made this first commit, you should be able to set <code>versionState</code> back to <code>appVersion</code> to update and pull the latest version of the app from the parameter store.</p><p>You should now be able to view and test your lambda function from each environment you&#x27;ve deployed it into!</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="once-you-have-completed-your-template-set-up-follow-the-instructions-in-the-included-readme-file-or-head-back-to-the-getting-started---extension-guide-for-more-information-on-bootstrapping-your-new-cdk-cosmos-extension"></a>Once you have completed your template set up, follow the instructions in the included readme file or head back to the <a href="/law/guides/getting_started_extension">Getting Started - Extension</a> guide for more information on bootstrapping your new CDK-Cosmos Extension<a aria-hidden="true" tabindex="-1" class="hash-link" href="#once-you-have-completed-your-template-set-up-follow-the-instructions-in-the-included-readme-file-or-head-back-to-the-getting-started---extension-guide-for-more-information-on-bootstrapping-your-new-cdk-cosmos-extension" title="Direct link to heading">#</a></h4><hr></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/cdk-cosmos/law/edit/master/guides/templates_lambda.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/law/guides/templates_ecr"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Building an ECR template</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3klQ"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#libci-cd-solar-systemts" class="table-of-contents__link">lib/ci-cd-solar-system.ts</a></li><li><a href="#libcosmosts" class="table-of-contents__link">lib/cosmos.ts</a></li><li><a href="#bingalaxyts" class="table-of-contents__link">bin/galaxy.ts</a></li><li><a href="#libsolar-systemts" class="table-of-contents__link">lib/solar-system.ts</a></li><li><a href="#binmaints" class="table-of-contents__link">bin/main.ts</a></li><li><a href="#internet-connectivity" class="table-of-contents__link">Internet connectivity</a></li><li><a href="#final-steps" class="table-of-contents__link">Final Steps</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="text--center"><div>Copyright Â© 2021 cdk-cosmos. Built with Docusaurus.</div></div></div></footer></div>
<script src="/law/styles.e4c59df8.js"></script>
<script src="/law/runtime~main.86f6e787.js"></script>
<script src="/law/main.3bdcd07c.js"></script>
<script src="/law/1.8571fb6d.js"></script>
<script src="/law/2.2961cee2.js"></script>
<script src="/law/236.315ef293.js"></script>
<script src="/law/237.a932438a.js"></script>
<script src="/law/284db4bf.4c9bf30e.js"></script>
<script src="/law/17896441.15f9fc3d.js"></script>
<script src="/law/994b2ab4.91efbcac.js"></script>
</body>
</html>